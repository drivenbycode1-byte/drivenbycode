,m{% extends 'dbc_app/base.html' %}

{% block page_header %}
<div class="p-3 mb-4">
  <div class="container-fluid py-4">
    <h1 class="display-5 oswald-subrayado">¡Hola!</h1>
    <p class="lead oswald">
      Mi nombre es Diego Silva Baeza y en diciembre del año 2023 sufrí un accidente en moto que me provocó 
      una lesión medular y me dejó con una paraplejia incompleta a nivel T4.
      Creé esta página para que sea una ventana en donde puedan asomarse y ver una parte de mi vida, y también para poder
      aludir a quienes se sientan en lo más profundo. 
      Publicaré mis proyectos, mis avances con la electroestimulación, mi recorrido por el paraatletismo,
      mi pasión por la programación, expresaré mis pensamientos en el blog y estaré dando noticias de mi primer libro.<br><br>
      ¡Que el viaje y el final valgan la pena!
    </p>
  </div>
</div>
{% endblock page_header %}

def index(request):
    TITULOS_POR_ID = {
        1: "SpiritInMotion",
        2: "Antes de Rendirte",
        3: "Blog",
        4: "Preguntas y Comunidad",
        5: "Sobre mí",
        6: "Proyectos"
    }

    md_posts = []
    tags_disponibles = set()

    if os.path.exists(CONTENT_DIR):
        for folder in os.listdir(CONTENT_DIR):
            folder_path = os.path.join(CONTENT_DIR, folder)
            if os.path.isdir(folder_path):
                for filename in sorted(os.listdir(folder_path), reverse=True):
                    if filename.endswith('.md'):
                        filepath = os.path.join(folder_path, filename)
                        try:
                            with open(filepath, 'r', encoding='utf-8') as f:
                                content = f.read()

                            if content.startswith('---'):
                                _, front_matter, text = content.split('---', 2)
                                metadata = yaml.safe_load(front_matter)
                                title = metadata.get('title', filename.replace('.md', ''))
                                date_obj = metadata.get('date')
                                if date_obj:
                                    date_obj = make_aware(datetime.strptime(str(date_obj), '%Y-%m-%d'))
                                tags = metadata.get('tags', [])
                                summary = metadata.get('summary', '')
                            else:
                                title = filename.replace('.md', '')
                                text = content
                                date_obj = None
                                tags = []
                                summary = ''

                            tags_disponibles.update(tags)

                            raw_excerpt = ' '.join(text.split()[:85])
                            html_excerpt = markdown.markdown(raw_excerpt, extensions=['extra', 'nl2br'])

                            try:
                                dbc_id = int(folder.replace("indice_", ""))
                            except:
                                dbc_id = 0

                            md_posts.append({
                                'title': title,
                                'text': html_excerpt,
                                'data_added': date_obj,
                                'dbc_id': dbc_id,
                                'source': 'markdown',
                                'tags': tags,
                                'summary': summary
                            })

                        except Exception as e:
                            continue

    def get_date(entry):
        return entry.get('data_added') or make_aware(datetime.min)

    md_posts.sort(key=get_date, reverse=True)

    context = {
        'blog_entries': md_posts,
        'tags_disponibles': sorted(tags_disponibles),
        'titulos_por_id': TITULOS_POR_ID
    }

    return render(request, 'dbc_app/index.html', context)
